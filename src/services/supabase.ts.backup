import 'react-native-url-polyfill/auto';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { createClient } from '@supabase/supabase-js';
import { ENV, devLog } from '../config/environment';

// Environment-aware configuration
const supabaseUrl = ENV.supabase.url;
const supabaseAnonKey = ENV.supabase.anonKey;

// Development-only logging
devLog('Supabase client initialization', {
  environment: ENV.app.environment,
  url: supabaseUrl,
  hasKey: !!supabaseAnonKey,
});

if (!supabaseUrl || !supabaseAnonKey) {
  const error = `[SupabaseClient] Missing credentials for ${ENV.app.environment} environment`;
  console.error(error);
  throw new Error(error);
}

// The createClient function expects the URL and key to be strings.
// If they are undefined (because they are not set in .env),
// Supabase client creation will fail at runtime, which is expected.
// Adding non-null assertion operator (!) as we are warning above if they are not set.
export const supabase = createClient(supabaseUrl!, supabaseAnonKey!, {
  auth: {
    storage: AsyncStorage,
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: false,
  },
});
